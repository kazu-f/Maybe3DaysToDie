#include "stdafx.h"
#include "GameScene.h"
#include "Scene\TerrainDebugScene.h"

//1フレームの経過時間を出力する。
#define CALC_TIME

LRESULT  CALLBACK   WndProc(HWND, UINT, WPARAM, LPARAM);

 MauseState g_MauseState= MauseState::None;

LRESULT  CALLBACK  WndProc(HWND hWnd, UINT msg, WPARAM wParam, LPARAM lParam) {
	HDC         hdc;
	PAINTSTRUCT ps;
	float x = 0.0f;
	float y = 0.0f;
	//渡された message から、イベントの種類を解析する
	switch (msg) {
	case WM_CREATE:
		x = 50;
		y = 50;
		break;
	case WM_LBUTTONDOWN:
		g_MauseState = MauseState::LBotunClick;
		x = LOWORD(lParam);
		y = HIWORD(lParam);
		InvalidateRect(hWnd, NULL, TRUE);  //領域無効化
		break;
	case WM_RBUTTONDOWN:
		x = LOWORD(lParam);
		y = HIWORD(lParam);
		InvalidateRect(hWnd, NULL, TRUE);  //領域無効化
		break;
		//----ペイント----
	case WM_PAINT:
		break;
		//----終了処理----
	case WM_DESTROY:
		PostQuitMessage(0);
		return 0L;
	}
	//デフォルトの処理
	return  DefWindowProc(hWnd, msg, wParam, lParam);
}
void SetInitParam(SInitParam& initParam)
{
	initParam.frameBuffer_W = FRAME_BUFFER_W;	//フレームバッファのサイズ(幅)
	initParam.frameBuffer_H = FRAME_BUFFER_H;	//フレームバッファのサイズ(高さ)
	initParam.gameObjectPrioMax = 20;			//ゲームオブジェクトの優先度の最大数。

	initParam.graphicsConf.shadowConf.isEnable = true;		//シャドウマップの有効化フラグ。
	initParam.graphicsConf.shadowConf.shadowMapWidth = 4096;
	initParam.graphicsConf.shadowConf.shadowMapWidth = 4096;
	initParam.graphicsConf.shadowConf.shadowAreas[0] = 2000.0f;		//シャドウマップの有効範囲(近景)
	initParam.graphicsConf.shadowConf.shadowAreas[1] = 4000.0f;		//シャドウマップの有効範囲(中景)
	initParam.graphicsConf.shadowConf.shadowAreas[2] = 20000.0f;	//シャドウマップの有効範囲(遠景)
	//initParam.graphicsConf.shadowConf.depthOffset[0] = 0.01f;
	//initParam.graphicsConf.shadowConf.depthOffset[1] = 0.02f;
	//initParam.graphicsConf.shadowConf.depthOffset[2] = 0.02f;
	initParam.graphicsConf.shadowConf.lightHeight = 5000.0f;
	initParam.graphicsConf.postEffectConf.tonemap.isEnable = false;		//トーンマップ有効化フラグ。
	initParam.graphicsConf.postEffectConf.tonemap.luminance = 0.24f;	//明るさ。
	initParam.graphicsConf.postEffectConf.isBloom = true;	//ブルームの有効化フラグ。
	initParam.graphicsConf.postEffectConf.isFxaa = true;	//アンチエイリアス有効化フラグ。
}

///////////////////////////////////////////////////////////////////
// ウィンドウプログラムのメイン関数。
///////////////////////////////////////////////////////////////////
int WINAPI wWinMain(HINSTANCE hInstance, HINSTANCE hPrevInstance, LPWSTR lpCmdLine, int nCmdShow)
{
	SInitParam initParam;
	SetInitParam(initParam);
	WNDCLASS wc = { CS_CLASSDC,
				   WndProc,                               //イベントcallback関数
				   0L,
				   0L,
				   hInstance,
				   NULL,                                  //アイコン
				   LoadCursor(NULL,IDC_ARROW),            //マウスカーソル
				   (HBRUSH)GetStockObject(WHITE_BRUSH),
				   NULL,
				   TEXT("Game")
	};
	if (RegisterClass(&wc) == 0) return FALSE;

	//ゲームの初期化。
	InitGame(hInstance, hPrevInstance, lpCmdLine, nCmdShow, TEXT("Game"), initParam);
	//デバッグモードオン
	//PhysicsWorld().SetDebugMode(1);
	//フェードイン
	CFade::GetInstance()->StartFadeIn();
	//マウスカーソルの表示を消す
	ShowCursor(false);

	NewGO<CGameScene>(0);
	//NewGO<TerrainDebugScene>(0);
#ifdef CALC_TIME
	Stopwatch sw;
#endif
	// ここからゲームループ。
	while (DispatchWindowMessage())
	{
#ifdef CALC_TIME
		//1フレームの経過時間を測る。
		sw.Start();
#endif
		GameEngine().GameUpdate();

#ifdef CALC_TIME
		sw.Stop();
#endif
		
#ifdef CALC_TIME
		char text[256];
		sprintf_s(text, "1フレームの経過時間::%dミリ秒\n", static_cast<int>(sw.GetElapsedMillisecond()));
		OutputDebugString(text);
#endif

	}
	return 0;
}


